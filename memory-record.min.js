/**
 memory-record - activerecord like in-memory data manager
 @version v0.0.8
 @link https://github.com/7korobi/memory-record
 @license 
**/
(function(){this.Mem=function(){function t(){}return t.rule={},t}()}).call(this),function(){this.Mem.Finder=function(){function t(t){var e;this.sort_by=t,e=new Mem.Query(this,[],!1,this.sort_by),e._memory={},this.scope={all:e},this.query={all:e}}return t.prototype.rehash=function(t,e){var r,n,i;for(delete this.query.all._reduce,delete this.query.all._list,delete this.query.all._hash,this.query={all:this.query.all},r=0,n=t.length;n>r;r++)i=t[r],i.rehash(e)},t.prototype.calculate_reduce=function(t){var e,r,n,i,u,s,o,l,c,a,h,f,d,p,m,_,y,g,v,b;o=function(t){var e;return e={},t.count&&(e.count=0),t.all&&(e.all=0),e},y=function(t,e,r){return r.max<=e.max||(e.max_is=t,e.max=r.max),e.min<=r.min||(e.min_is=t,e.min=r.min),r.count&&(e.count+=r.count),r.all?e.all+=r.all:void 0},r=function(t){return t.all&&t.count?t.avg=t.all/t.count:void 0},e={},g=t._memory;for(s in g)for(v=g[s],l=v.item,n=v.emits,u=0,d=n.length;d>u;u++){for(b=n[u],h=b[0],f=b[1],m=b[2],_=e,c=0,p=h.length;p>c;c++)a=h[c],_=_[a]||(_[a]={});_=_[f]||(_[f]=o(m)),y(l,_,m)}for(i in e){n=e[i];for(a in n)m=n[a],r(m)}return t._reduce=e},t.prototype.calculate_sort=function(t){var e,r,n,i,u,s,o,l,c;for(u=t._list,l=t.desc?[1,-1]:[-1,1],s=l[0],e=l[1],c=t.orders={},r=0,i=u.length;i>r;r++)o=u[r],c[o._id]=t.sort_by(o);return u.length&&(n=Array.isArray(t.sort_by(u[0]))),t._list=n?u.sort(function(t,r){var n,i,u,o,l,a,h;for(n=c[t._id],u=c[r._id],l=a=0,h=n.length;h>a;l=++a){if(i=n[l],o=u[l],o>i)return s;if(i>o)return e}return 0}):u.sort(function(t,r){var n,i;return n=c[t._id],i=c[r._id],i>n?s:n>i?e:0})},t.prototype.calculate_group=function(t){var e,r,n,i,u;return i=t._distinct,n=i.reduce,u=i.target,t._list=function(){var i,s;i=t._reduce[n],s=[];for(e in i)r=i[e],s.push(r[u]);return s}()},t.prototype.calculate_list=function(t,e){var r,n,i,u;return t._memory===e?r=function(e,r){return t._hash[e]=r.item}:(t._memory={},r=function(e,r){return t._memory[e]=r,t._hash[e]=r.item}),t._hash={},t._list=function(){var s,o,l,c;c=[];for(i in e){for(u=e[i],l=t.filters,s=0,o=l.length;o>s&&(n=l[s],n(u.item)||(u=null),u);s++);u&&c.push(r(i,u))}return c}()},t.prototype.calculate=function(t){this.calculate_list(t,this.query.all._memory),t._list.length&&null!=this.map_reduce&&(this.calculate_reduce(t),null!=t._distinct&&this.calculate_group(t)),this.calculate_sort(t)},t}()}.call(this),function(){var t,e,r,n=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1},i=[].slice;r=Object.prototype.toString,e=function(t){return r.call(t).slice(8,-1)},t=function(t,e,r){var n,i,u,s;u=r.get,s=r.set,n=!1,i=!1,Object.defineProperty(t,e,{configurable:n,enumerable:i,get:u,set:s})},this.Mem.Query=function(){function r(t,e,r,n){this.finder=t,this.filters=e,this.desc=r,this.sort_by=n}return r.prototype._filters=function(t,r){var n,i,u;if(!t)return this;switch(n=this.filters.concat(),e(t)){case"Object":for(u in t)i=t[u],n.push(r(u,i));break;case"Function":n.push(r(null,t));break;default:throw console.log([e(t,t)]),Error("unimplemented")}return new Mem.Query(this.finder,n,this.desc,this.sort_by)},r.prototype["in"]=function(t){return this._filters(t,function(t,r){switch(e(r)){case"Array":return function(e){var i,u,s;for(i=0,s=r.length;s>i;i++)if(u=r[i],n.call(e[t],u)>=0)return!0;return!1};case"RegExp":return function(e){var n,i,u,s;for(u=e[t],n=0,i=u.length;i>n;n++)if(s=u[n],r.test(s))return!0;return!1};case"Null":case"Boolean":case"String":case"Number":return function(e){return n.call(e[t],r)>=0};default:throw console.log([e(r,r)]),Error("unimplemented")}})},r.prototype.distinct=function(t,e){var r;return r=new Mem.Query(this.finder,this.filters,this.desc,this.sort_by),r._distinct={reduce:t,target:e},r},r.prototype.where=function(t){return this._filters(t,function(t,r){switch(e(r)){case"Array":return function(e){var i;return i=e[t],n.call(r,i)>=0};case"RegExp":return function(e){return r.test(e[t])};case"Function":return r;case"Null":case"Boolean":case"String":case"Number":return function(e){return e[t]===r};default:throw console.log([e(r,r)]),Error("unimplemented")}})},r.prototype.search=function(t){var e,r,n;return t?(r=function(){var r,n,i,u;for(i=t.split(/\s+/),u=[],r=0,n=i.length;n>r;r++)e=i[r],e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),e.length&&u.push("("+e+")");return u}(),r.length?(n=new RegExp(r.join("|"),"ig"),this.where(function(t){return!t.search_words||n.test(t.search_words)})):this):this},r.prototype.sort=function(t,r){var n;return null==r&&(r=this.sort_by),n=function(){switch(e(r)){case"Function":return r;case"String":case"Number":return function(t){return t[r]};default:throw console.log([e(req,req)]),Error("unimplemented")}}(),t===this.desc&&n===this.sort_by?this:new Mem.Query(this.finder,this.filters,t,n)},r.prototype.clear=function(){return delete this._reduce,delete this._list,delete this._hash,delete this._memory},t(r.prototype,"reduce",{get:function(){return null==this._reduce&&this.finder.calculate(this),this._reduce}}),t(r.prototype,"list",{get:function(){return null==this._list&&this.finder.calculate(this),this._list}}),t(r.prototype,"hash",{get:function(){return null==this._hash&&this.finder.calculate(this),this._hash}}),t(r.prototype,"memory",{get:function(){return null==this._memory&&this.finder.calculate(this),this._memory}}),t(r.prototype,"ids",{get:function(){return Object.keys(this.memory)}}),r.prototype.find=function(t){return this.hash[t]},r.prototype.finds=function(t){var e,r,n,i,u;for(u=[],e=0,n=t.length;n>e;e++)r=t[e],(i=this.hash[r])&&u.push(i);return u},r.prototype.pluck=function(){var t;switch(t=1<=arguments.length?i.call(arguments,0):[],t.length){case 0:return this.list.map(function(){return null});case 1:return this.list.map(function(e){return e[t[0]]});default:return this.list.map(function(e){var r,n,i,u;for(u=[],r=0,i=t.length;i>r;r++)n=t[r],u.push(e[n]);return u})}},r}()}.call(this),function(){var t,e,r,n=[].slice;r=Object.prototype.toString,e=function(t){return r.call(t).slice(8,-1)},t=function(t,e,r){var n,i,u,s;u=r.get,s=r.set,n=!1,i=!1,Object.defineProperty(t,e,{configurable:n,enumerable:i,get:u,set:s})},this.Mem.Rule=function(){function r(t){var e;this.id=t+"_id",this.list_name=t+"s",this.base_obj={},this.validates=[],this.responses=null!=(e=Mem.Rule.responses)[t]?e[t]:e[t]=[],this.map_reduce=function(){},this.protect=function(){},this.deploy=function(t){return function(e){return e._id||(e._id=e[t.id]),e[t.id]?void 0:e[t.id]=e._id}}(this),this.finder=new Mem.Finder(function(t){return t}),this.finder.name=this.list_name,Mem.rule[t]=this,Mem[this.list_name]=this.finder.query.all}return r.responses={},r.prototype.schema=function(r){var i,u;return i=function(t,r,i){switch(e(i)){case"Function":return r.query.all[t]=function(){var e,u,s;return e=1<=arguments.length?n.call(arguments,0):[],null!=(u=r.query)[s=t+":"+JSON.stringify(e)]?u[s]:u[s]=i.apply(null,e)};default:return r.query.all[t]=i}},u={scope:function(t){return function(e){var r,n,u,s;t.finder.scope=e(t.finder.query.all),u=t.finder.scope,s=[];for(r in u)n=u[r],s.push(i(r,t.finder,n));return s}}(this),"default":function(t){return function(e){var r,n,i,u;n=e(),i=[];for(r in n)u=n[r],i.push(t.base_obj[r]=u);return i}}(this),depend_on:function(t){return function(e){var r;return null==(r=Mem.Rule.responses)[e]&&(r[e]=[]),Mem.Rule.responses[e].push(t)}}(this),belongs_to:function(e){return function(r,n){var i,s,o;return o=r+"s",s=r+"_id",t(e.base_obj,r,{get:function(){return Mem[o].find(this[s])}}),i=null!=(null!=n?n.dependent:void 0),i?(u.depend_on(r),e.validates.push(function(t){return null!=t[r]})):void 0}}(this),has_many:function(e){return function(r,n){var u,s,o;return s=e.id,u=e.finder.query.all,o=null!=n?n.query:void 0,i(r,e.finder,function(t){return null==o&&(o=Mem[r]),o.where(function(e){return e[s]===t})}),t(e.base_obj,r,{get:function(){return u[r](this._id)}})}}(this),order:function(t){return function(e){var r;return r=t.finder.query.all.sort(!1,e),r._memory=t.finder.query.all._memory,Mem[t.list_name]=t.finder.query.all=r}}(this),protect:function(t){return function(){var e;return e=1<=arguments.length?n.call(arguments,0):[],t.protect=function(t,r){var n,i,u,s;for(s=[],n=0,u=e.length;u>n;n++)i=e[n],s.push(t[i]=r[i]);return s}}}(this),deploy:function(t){return function(e){t.deploy=e}}(this),map_reduce:function(t){return function(e){t.map_reduce=e}}(this)},r.call(u,this)},r.prototype.rehash=function(t){return this.finder.rehash(this.responses,t)},r.prototype.set_base=function(t,r,i){var u,s,o,l,c,a;switch(c=this.finder,o=c.diff,u=c.query.all._memory,s=function(t){return function(e){return e.__proto__=t.base_obj,t.deploy(e)}}(this),a=function(t){return function(e){var r,n,i,u;for(i=t.validates,r=0,n=i.length;n>r;r++)if(u=i[r],!u(e))return!1;return!0}}(this),l=function(t){var n,i,u,s,o,l;switch(e(r)){case"Array":for(o=r||[],n=0,s=o.length;s>n;n++)u=o[n],u&&t(u);break;case"Object":l=r||{};for(i in l)u=l[i],u&&(u._id=i,t(u))}},t){case"merge":l(function(t){return function(e){var r,l,h,f,d;for(l in i)d=i[l],e[l]=d;s(e),a(e)&&(h={item:e,emits:[]},f=u[e._id],null!=f?(t.protect(e,f.item),o.change=!0):o.add=!0,u[e._id]=h,r=function(){var t,e,r,i;return e=3<=arguments.length?n.call(arguments,0,t=arguments.length-2):(t=0,[]),r=arguments[t++],i=arguments[t++],c.map_reduce=!0,h.emits.push([e,r,i])},t.map_reduce(h.item,r))}}(this));break;default:l(function(t){return function(t){var e;e=u[t._id],null!=e&&(o.del=!0,delete u[t._id])}}(this))}this.rehash(o)},r.prototype.set=function(t,e){var r,n,i;this.finder.diff={},n=this.finder.query.all._memory;for(r in n){i=n[r],this.finder.query.all._memory={},this.finder.diff.del=!0;break}return this.set_base("merge",t,e)},r.prototype.reject=function(t){return this.finder.diff={},this.set_base(!1,t,null)},r.prototype.merge=function(t,e){return this.finder.diff={},this.set_base("merge",t,e)},r}()}.call(this);