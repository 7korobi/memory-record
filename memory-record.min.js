/**
 memory-record - activerecord like in-memory data manager
 @version v0.3.0
 @link https://github.com/7korobi/memory-record
 @license 
**/


(function(){var a;module.exports=a={Base:{},Query:{},Model:{},Collection:{},Composite:{}}}).call(this),function(){var a,b,c,d,e,f,g;b=function(){return new Object(null)},g=function(a,b){return this.rule.finder.reset(a,b)},e=function(a,b){return this.rule.finder.merge(a,b)},f=function(a){return this.rule.finder.remove(a)},d=function(a){return function(b,c){return a.call(this,[b],c)}},c=function(){return this.rule.finder.clear_cache()},a=module.exports,a.Base.Collection=function(){function a(a){this.rule=a}return a.prototype.set=g,a.prototype.reset=g,a.prototype.merge=e,a.prototype.reject=f,a.prototype.add=d(e),a.prototype.append=d(e),a.prototype.create=d(e),a.prototype.del=d(f),a.prototype.remove=d(f),a.prototype.clear_cache=c,a.prototype.refresh=c,a.prototype.rehash=c,a}()}.call(this),function(){var a,b,c,d,e,f,g=[].slice;c=require("lodash"),b=function(){return new Object(null)},e=function(a,b){var c,d,e,f;switch(null!=a?a.constructor:void 0){case Array:for(c=0,f=a.length;c<f;c++)e=a[c],b(e);break;case Object:for(d in a)e=a[d],e._id=d,b(e);break;default:throw new Error("detect bad data: "+JSON.stringify(a))}},f=function(a,b){var c,d,e;for(d=0,e=b.length;d<e;d++)if(c=b[d],!c(a))return!1;return!0},d=function(a,b){var c;return c=b+"s",a[c]={},a["set_"+b]=function(b,d){var e;return null==(e=a[c])[b]&&(e[b]=[]),a[c][b].push(d)}},a=module.exports,a.Base.Finder=function(){function h(b){this.name=b,this.all=a.Base.Query.build(this),this.all.cache={},this.scope={},this.property={first:{enumerable:!1,get:function(){return this[0]}},last:{enumerable:!1,get:function(){return this[this.length-1]}},pluck:{enumerable:!1,value:function(){var a;switch(a=arguments,a.length){case 0:return this.map(function(){return null});case 1:return this.map(function(b){return c.at(b,a[0])[0]});default:return this.map(function(b){return c.at.apply(c,[b].concat(g.call(a)))})}}}}}return d(h,"depend"),d(h,"validate"),h.prototype.validates=function(){return h.validates[this.name.base]},h.prototype.use_cache=function(a,b){switch(this.scope[a]=b,null!=b?b.constructor:void 0){case Function:return this.all[a]=function(c){return function(){var d,e,f;return d=1<=arguments.length?g.call(arguments,0):[],null!=(e=c.all.cache)[f=a+":"+JSON.stringify(d)]?e[f]:e[f]=b.apply(null,d)}}(this);default:return this.all[a]=b}},h.prototype.clear_cache=function(){delete this.all._reduce,delete this.all._list,delete this.all._hash,this.all.cache={}},h.prototype.cleanup=function(){var a,b,c,d,e;for(d=h.depends[this.name.base],e=[],b=0,c=d.length;b<c;b++)a=d[b],e.push(a(this));return e},h.prototype.save=function(a){var b,c,d,e,f,g;for(f=a.list,g=[],c=0,e=f.length;c<e;c++)d=f[c],g.push(function(){var a,c,e,f;for(e=this.validates(),f=[],a=0,c=e.length;a<c;a++)b=e[a],b(d)||f.push(this.model.save(d));return f}.call(this));return g},h.prototype.calculate=function(a){this.list(a,this.all._memory),a._list.length&&this.model.do_map_reduce&&(this.reduce(a),null!=a._group&&this.group(a,a._group)),this.sort(a),Object.defineProperties(a._list,this.property)},h.prototype.reduce=function(a){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;i=function(a){var c;return c=b(),a.count&&(c.count=0),a.all&&(c.all=0),a.list&&(c.list=[]),a.set&&(c.set=b()),c},p=function(a,b,c){if(c.list&&b.list.push(c.list),c.set&&(b.set[c.set]=!0),c.max<=b.max||(b.max_is=a,b.max=c.max),b.min<=c.min||(b.min_is=a,b.min=c.min),c.count&&(b.count+=c.count),c.all)return b.all+=c.all},e=function(a){if(a.all&&a.count)return a.avg=a.all/a.count},d=b(),o=b(),q=a._memory;for(h in q)for(r=q[h],j=r.item,f=r.emits,g=0,k=f.length;g<k;g++)s=f[g],n=s[0],l=s[1],m=c.get(d,n),m||(m=o[n.join(".")]=i(l),c.set(d,n,m)),p(j,m,l);for(n in o)m=o[n],e(m);return a._reduce=d},h.prototype.sort=function(a){var b,d,e;if(d=a._sort,e=d[0],b=d[1],null!=e)return a._list=null!=b?c.orderBy(a._list,e,b):c.sortBy(a._list,e)},h.prototype.group=function(a){var d,e,f,g,h,i,j,k,l;return j=a._group,g=j.reduce,k=j.target,h=c.property(g),l=c.property(k),d=function(b,c){return a._memory[b]=c,a._hash[b]=c.item},a._memory=b(),a._hash=b(),a._list=function(){var b,c;b=h(a._reduce),c=[];for(e in b)i=b[e],f=l(i),c.push(d(f._id,f));return c}()},h.prototype.list=function(a,c){var d,e,g;return a._memory===c?d=function(b,c){return a._hash[b]=c.item}:(a._memory=b(),d=function(b,c){return a._memory[b]=c,a._hash[b]=c.item}),a._hash=b(),a._list=function(){var b,h,i,j,k;for(j=null!=(i=a._all_ids)?i:Object.keys(c),k=[],b=0,h=j.length;b<h;b++)e=j[b],g=c[e],f(g.item,a._filters)&&k.push(d(e,g));return k}()},h.prototype.remove=function(a){var b;return b=this.all._memory,e(a,function(a){return function(c){var d;d=b[c._id],null!=d&&(a.model.delete(d.item),delete b[c._id])}}(this)),this.cleanup()},h.prototype.reset=function(a,c){var d,e,f,g,h;d=this.all._memory,this.all._memory=g=b(),this.merge(a,c);for(f in d)h=d[f],e=g[f],null!=e?this.model.update(e,h.item):this.model.delete(h);return this.cleanup()},h.prototype.merge=function(a,b){var c;return c=this.all._memory,this.model.do_map_reduce=!1,e(a,function(a){return function(d){var e,h,i,j;d.__proto__=a.model.prototype;for(e in b)j=b[e],d[e]=j;if(a.model.call(d,a.model),!d._id)throw new Error("detect bad data: "+JSON.stringify(d));f(d,a.validates())&&(h={item:d,emits:[]},a.model.map_reduce(d,function(){var b,c,d;return d=2<=arguments.length?g.call(arguments,0,c=arguments.length-1):(c=0,[]),b=arguments[c++],h.emits.push([d,b]),a.model.do_map_reduce=!0}),i=c[d._id],null!=i?a.model.update(d,i.item):(a.model.create(d),a.model.rowid++),c[d._id]=h)}}(this)),this.cleanup()},h}()}.call(this),function(){var a;a=module.exports,a.Base.Model=function(){function a(a){this._id||(this._id=this[a.id]),this[a.id]||(this[a.id]=this._id)}return a.rowid=0,a.save=function(a){},a.update=function(a,b){},a.create=function(a){},a.delete=function(a){},a.validate=function(a){return!0},a.map_reduce=function(a,b){},a}()}.call(this),function(){var a,b,c,d,e,f=[].slice;c=require("lodash"),b=function(){return new Object(null)},e=function(a){var c,d,e,f;for(f=b(),c=0,e=a.length;c<e;c++)d=a[c],f[d]=!0;return f},d=function(b,d,e){return d?new a.Base.Query(b,function(){var a,f,g;switch(this._filters=b._filters.concat(),null!=d?d.constructor:void 0){case Object:f=[];for(a in d)g=d[a],f.push(e(this,a,g,c.property(a)));return f;break;case Function:case Array:case String:return e(this,null,d,function(a){return a});default:throw console.log({req:d}),Error("unimplemented")}}):b},a=module.exports,a.Base.Query=function(){function g(a,b){this._copy(a),b.call(this)}return g.build=function(c){var d,e,f,g;return d=f=null,e=[],g=[],new a.Base.Query({_finder:c,_all_ids:d,_group:f,_filters:e,_sort:g},function(){return this._memory=b()})},g.prototype._copy=function(a){this._finder=a._finder,this._all_ids=a._all_ids,this._group=a._group,this._filters=a._filters,this._sort=a._sort},g.prototype.in=function(a){return d(this,a,function(a,b,c,d){var f,g;switch(f=function(b){return a._filters.push(b)},null!=c?c.constructor:void 0){case Array:return g=e(c),f(function(a){var b,c,e,f;for(f=d(a),b=0,e=f.length;b<e;b++)if(c=f[b],g[c])return!0;return!1});case RegExp:return f(function(a){var b,e,f,g;for(f=d(a),b=0,e=f.length;b<e;b++)if(g=f[b],c.test(g))return!0;return!1});case null:case Boolean:case String:case Number:return f(function(a){var b;return-1<(null!=(b=d(a))?b.indexOf(c):void 0)});default:throw console.log({target:b,req:c,path:d}),Error("unimplemented")}})},g.prototype.where=function(a){return d(this,a,function(a,b,c,d){var f,g;switch(f=function(b){return a._filters.push(b)},null!=c?c.constructor:void 0){case Function:return f(c);case Array:return"_id"===b?a._all_ids=c:(g=e(c),f(function(a){return g[d(a)]}));break;case RegExp:return f(function(a){return c.test(d(a))});case null:case Boolean:case String:case Number:return"_id"===b?a._all_ids=[c]:f(function(a){return c===d(a)});break;default:throw console.log({target:b,req:c,path:d}),Error("unimplemented")}})},g.prototype.search=function(a){var b,c,d;return a?(c=function(){var c,d,e,f;for(e=a.split(/\s+/),f=[],c=0,d=e.length;c<d;c++)b=e[c],b=b.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),b.length&&f.push("("+b+")");return f}(),c.length?(d=new RegExp(c.join("|"),"ig"),this.where(function(a){return!a.search_words||d.test(a.search_words)})):this):this},g.prototype.distinct=function(a,b){var d;return d={reduce:a,target:b},c.isEqual(d,this._group)?this:new g(this,function(){return this._group=d})},g.prototype.sort=function(){var a;return a=1<=arguments.length?f.call(arguments,0):[],c.isEqual(a,this._sort)?this:new g(this,function(){return this._sort=a})},g.prototype.shuffle=function(){return new g(this,function(){return this._sort=[Math.random]})},g.prototype.save=function(){return this._finder.save(this)},g.prototype.find=function(a){return this.hash[a]},g.prototype.finds=function(a){var b,c,d,e,f;for(f=[],b=0,d=a.length;b<d;b++)c=a[b],(e=this.hash[c])&&f.push(e);return f},g.prototype.pluck=function(){var a;return(a=this.list).pluck.apply(a,arguments)},Object.defineProperties(g.prototype,{reduce:{get:function(){return null==this._reduce&&this._finder.calculate(this),this._reduce}},list:{get:function(){return null==this._list&&this._finder.calculate(this),this._list}},hash:{get:function(){return null==this._hash&&this._finder.calculate(this),this._hash}},memory:{get:function(){return null==this._memory&&this._finder.calculate(this),this._memory}},ids:{get:function(){return Object.keys(this.memory)}}}),g}()}.call(this),function(){var a,b,c,d,e=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},f={}.hasOwnProperty;b=require("lodash"),c={},d=function(a){var b,d,e,f;return(f=c[a])?f:(b=a+"_id",d=a+"_ids",e=a+"s",c[a]={id:b,ids:d,list:e,base:a})},a=module.exports,a.Rule=function(){function c(b,c){this.name=d(b),this.depend_on(b),this.finder=new a.Base.Finder(this.name),this.model=a.Base.Model,this.dml=new a.Base.Collection(this),this.property={},c&&this.schema(c)}return c.prototype.schema=function(b){return b.call(this,this.dml),this.model===a.Base.Model&&(this.model=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return e(b,a),b}(this.model)),this.model.id=this.name.id,this.model.ids=this.name.ids,this.model.list=this.name.list,Object.defineProperties(this.model.prototype,this.property),this.model.validate&&this.validate(this.model.validate),a.Collection[this.name.base]=this.dml,a.Model[this.name.base]=this.finder.model=this.model,a.Query[this.name.list]=this.finder.all,this},c.prototype.validate=function(b){return a.Base.Finder.set_validate(this.name.base,b)},c.prototype.depend_on=function(b){return a.Base.Finder.set_depend(b,function(a){return a.clear_cache()})},c.prototype.scope=function(a){var b,c,d,e;c=a(this.finder.all),d=[];for(b in c)e=c[b],d.push(this.finder.use_cache(b,e));return d},c.prototype.default_scope=function(a){var b;return b=this.finder.all,b._copy(a(b))},c.prototype.shuffle=function(){return this.default_scope(function(a){return a.shuffle()})},c.prototype.order=function(a,b){return this.default_scope(function(c){return c.sort(a,b)})},c.prototype.sort=function(a){return this.default_scope(function(b){return b.sort(a)})},c.prototype.relation_to_one=function(b,c,d){return this.property[b]={enumerable:!0,get:function(){return a.Query[c].find(this[d])}}},c.prototype.relation_to_many=function(b,c,d,e){var f;return f=this.finder.all,this.finder.use_cache(b,function(b){var d;return a.Query[c].where((d={},d[""+e]=b,d))}),this.property[b]={enumerable:!0,get:function(){return f[b](this[d])}}},c.prototype.relation_tree=function(a,b){var c;return c=this.finder.all,this.finder.use_cache(a,function(d,e){var f,g;return e?(g=c.where((f={},f[""+b]=d,f)),c[a](g.ids,e-1)):c.where({_id:d})}),this.property[a]={enumerable:!0,value:function(b){return c[a]([this._id],b)}}},c.prototype.relation_graph=function(a,c){var d;return d=this.finder.all,this.finder.use_cache(a,function(e,f){var g,h,i,j,k,l,m,n;if(m=d.where({_id:e}),f){for(e=[],n=m.pluck(c),h=0,k=n.length;h<k;h++)if(g=n[h],null!=g)for(i=0,l=g.length;i<l;i++)j=g[i],null!=j&&e.push(j);return d[a](b.uniq(e),f-1)}return m}),this.property[a]={enumerable:!0,value:function(b){return d[a]([this._id],b)}}},c.prototype.belongs_to=function(a,c){var e,f,g,h,i,j;if(null==c&&(c={}),g=d(a),f=null!=(h=c.key)?h:g.id,j=null!=(i=c.target)?i:g.list,e=c.dependent,this.relation_to_one(g.base,j,f),e)return this.depend_on(g.base),this.validate(b.property(g.base))},c.prototype.has_many=function(a,b){var c,e,f,g,h,i;switch(null==b&&(b={}),f=d(a.replace(/s$/,"")),e=b.key,i=null!=(h=b.target)?h:f.list,b.by){case"ids":c=null!=e?e:f.ids,g="_id";break;default:c="_id",g=null!=e?e:this.name.id}return this.relation_to_many(f.list,i,c,g)},c.prototype.tree=function(a){return null==a&&(a={}),this.relation_tree("nodes",this.name.id),this.belongs_to(this.name.base,a)},c.prototype.graph=function(a){var b,c,d;if(null==a&&(a={}),c=a.directed,b=a.cost,d=this.name.ids,this.relation_to_many(this.name.list,this.name.list,d,"_id"),this.relation_graph("path",d),!c)return!0},c}()}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;b=function(){return new Object(null)},k=null,e=function(a){var b,c,d,e,f;for(k={to_s:a,to_i:{}},f=k.to_s,e=c=0,d=f.length;c<d;e=++c)b=f[e],k.to_i[b]=e;return k.size=k.to_s.length},e("0123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),j=k.size*k.size*k.size,p=function(a){return function(b){switch(b){case"":case null:case void 0:return"";default:return a(b)}}},l=m=p(String),n=p(decodeURI),r=p(encodeURI),o=p(function(a){return String(a).replace(/[~\/=.&\?\#\[\]()\"'`;]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}),d=function(a){if(Array.isArray(a))return a;switch(a){case"":case null:case void 0:return[];default:return l(a).split(",")}},i={Url:{},Thru:function(a){return a},Keys:function(a){var b,c,d;return d=function(){var d;if(Array.isArray(a))return a;d=[];for(c in a)b=a[c],b&&d.push(c);return d}(),i.Array(d.sort())},Array:function(a){return Array.isArray(a)?a.join(","):l(a)},Date:function(a){var b,c;for(c=Math.floor(a),b="";c>=1;)b+=k.to_s[c%k.size],c=Math.floor(c/k.size);return b},Bool:function(a){return a?"T":"F"},Text:o,Cookie:o,Url:r,Number:m,String:m,null:m,undefined:m},q={Url:{},Thru:function(a){return a},HtmlGon:function(a){var b,c,d;for(c=/<script.*?>([\s\S]*?)<\/script>/gi,b=[];d=c.exec(a);)b.push(d[1]);return new Function("window",b.join("\n"))},Keys:function(a){var c,e,f,g,h,i;if(e=b(),a.length)for(i=d(a),f=0,h=i.length;f<h;f++)g=i[f],e[g]=!0;else for(g in a)c=a[g],c&&(e[g]=!0);return e},Array:function(a){return d(a)},Date:function(a){var b,c,d,f,g;if(0<a)return a;for(e=1,g=0,c=0,d=a.length;c<d;c++){if(b=a[c],f=k.to_i[b],null==f)return Number.NaN;g+=f*e,e*=k.size}return g},Bool:function(a){switch(a){case!0:case"T":return!0;case!1:case"F":return!1;default:return Number.NaN}},Text:n,Cookie:n,Url:n,Number:Number,String:l,null:l,undefined:l},c={url:{},ID:{now:function(){return c.ID.at(_.now())},at:function(a,b){return null==b&&(b=Math.random()*j),i.Date(a*j+b)}}},f="([^\\~\\/\\=\\.\\&\\[\\]\\(\\)\\\"\\'\\`\\;]*)";for(h in q)g=q[h],c.url[h]=function(){switch(h){case"Number":return"([-]?[\\.0-9]+)";case"Date":return"([0-9a-zA-Z]+)";case"Array":case"Keys":return f;case"Url":case"Cookie":return f;case"Text":return f;default:return f}}();a=module.exports,a.pack=i,a.unpack=q,a.Serial=c}.call(this);
//# sourceMappingURL=memory-record.min.js.map