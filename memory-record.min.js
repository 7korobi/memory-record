/**
 memory-record - activerecord like in-memory data manager
 @version v0.2.0
 @link https://github.com/7korobi/memory-record
 @license 
**/


(function(){var a;a=[].sort,Object.defineProperties(Array.prototype,{first:{get:function(){return this[0]}},last:{get:function(){return this[this.length-1]}},cycle:{value:function(a){var b,c,d,e;for(e=[],c=b=0,d=a;d>=0?d>=b:b>=d;c=d>=0?++b:--b)e.push(this[c%this.length]);return e}}})}).call(this),function(){var a;module.exports=a={Query:{},Model:{},Collection:{}}}.call(this),function(){var a,b;b=require("lodash"),a=module.exports,a.Finder=function(){function c(b,c){var d;this.sortBy=b,this.orderBy=c,d=new a.Query(this,[],this.sortBy,this.orderBy),d._memory={},this.scope={all:d},this.query={all:d}}return c.prototype.rehash=function(a){var b,c,d;for(delete this.query.all._reduce,delete this.query.all._list,delete this.query.all._hash,this.query={all:this.query.all},b=0,c=a.length;c>b;b++)d=a[b],d.rehash()},c.prototype._reduce=function(a){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;h=function(a){var b;return b={},a.count&&(b.count=0),a.all&&(b.all=0),a.list&&(b.list=[]),a.set&&(b.set={}),b},o=function(a,b,c){return c.list&&b.list.push(c.list),c.set&&(b.set[c.set]=!0),c.max<=b.max||(b.max_is=a,b.max=c.max),b.min<=c.min||(b.min_is=a,b.min=c.min),c.count&&(b.count+=c.count),c.all?b.all+=c.all:void 0},d=function(a){return a.all&&a.count?a.avg=a.all/a.count:void 0},c={},n={},p=a._memory;for(g in p)for(q=p[g],i=q.item,e=q.emits,f=0,j=e.length;j>f;f++)r=e[f],m=r[0],k=r[1],l=b.get(c,m),l||(l=n[m.join(".")]=h(k),b.set(c,m,l)),o(i,l,k);for(m in n)l=n[m],d(l);return a._reduce=c},c.prototype._sort=function(a){var c,d;return d=a.sortBy,c=a.orderBy,null!=d?a._list=null!=c?b.orderBy(a._list,d,c):b.sortBy(a._list,d):void 0},c.prototype._group=function(a){var b,c,d,e,f;return e=a._distinct,d=e.reduce,f=e.target,a._list=function(){var e,g;e=a._reduce[d],g=[];for(b in e)c=e[b],g.push(c[f]);return g}()},c.prototype._list=function(a,b){var c,d,e,f,g;return a._memory===b?d=function(b,c){return a._hash[b]=c.item}:(a._memory={},d=function(b,c){return a._memory[b]=c,a._hash[b]=c.item}),a._hash={},a._list=function(){var h,i,j,k;k=[];for(f in b){for(g=b[f],e=!0,j=a.filters,h=0,i=j.length;i>h;h++)if(c=j[h],!c(g.item)){e=!1;break}e&&k.push(d(f,g))}return k}()},c.prototype.calculate=function(a){this._list(a,this.query.all._memory),a._list.length&&null!=this.map_reduce&&(this._reduce(a),null!=a._distinct&&this._group(a)),this._sort(a)},c}()}.call(this),function(){var a,b,c,d=[].slice;b=require("lodash"),c=function(a){var b,c,d,e;for(e={},b=0,d=a.length;d>b;b++)c=a[b],e[c]=!0;return e},a=module.exports,a.Query=function(){function a(a,b,c,d){this.finder=a,this.filters=b,this.sortBy=c,this.orderBy=d}return a.prototype._filters=function(b,c){var d,e,f;if(!b)return this;switch(d=this.filters.concat(),null!=b?b.constructor:void 0){case Object:for(f in b)e=b[f],d.push(c(f,e));break;case Function:d.push(c(null,b));break;default:throw console.log([b,b]),Error("unimplemented")}return new a(this.finder,d,this.orderBy)},a.prototype["in"]=function(a){return this._filters(a,function(a,b){switch(null!=b?b.constructor:void 0){case Array:return function(d){var e,f,g,h;for(h=c(d[a]),e=0,g=b.length;g>e;e++)if(f=b[e],h[f])return!0;return!1};case RegExp:return function(c){var d,e,f,g;for(f=c[a],d=0,e=f.length;e>d;d++)if(g=f[d],b.test(g))return!0;return!1};case null:case Boolean:case String:case Number:return function(d){var e;return e=c(d[a]),e[b]};default:throw console.log([b,b]),Error("unimplemented")}})},a.prototype.distinct=function(b,c){var d;return d=new a(this.finder,this.filters,this.orderBy),d._distinct={reduce:b,target:c},d},a.prototype.where=function(a){return this._filters(a,function(a,b){var d;switch(null!=b?b.constructor:void 0){case Array:return d=c(b),function(b){return d[b[a]]};case RegExp:return function(c){return b.test(c[a])};case Function:return b;case null:case Boolean:case String:case Number:return function(c){return c[a]===b};default:throw console.log([type(b,b)]),Error("unimplemented")}})},a.prototype.search=function(a){var b,c,d;return a?(c=function(){var c,d,e,f;for(e=a.split(/\s+/),f=[],c=0,d=e.length;d>c;c++)b=e[c],b=b.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),b.length&&f.push("("+b+")");return f}(),c.length?(d=new RegExp(c.join("|"),"ig"),this.where(function(a){return!a.search_words||d.test(a.search_words)})):this):this},a.prototype.sort=function(c,d){return b.isEqual([c,d],[this.sortBy,this.orderBy])?this:new a(this.finder,this.filters,c,d)},a.prototype.shuffle=function(){return new a(this.finder,this.filters,Math.random)},a.prototype.clear=function(){return delete this._reduce,delete this._list,delete this._hash,delete this._memory},a.prototype.save=function(){return this.finder.save(this)},a.prototype.find=function(a){return this.hash[a]},a.prototype.finds=function(a){var b,c,d,e,f;for(f=[],b=0,d=a.length;d>b;b++)c=a[b],(e=this.hash[c])&&f.push(e);return f},a.prototype.pluck=function(){var a;switch(a=1<=arguments.length?d.call(arguments,0):[],a.length){case 0:return this.list.map(function(){return null});case 1:return this.list.map(function(c){var d;return d=b.at(c,a)[0]});default:return this.list.map(function(c){return b.at(c,a)})}},Object.defineProperties(a.prototype,{reduce:{get:function(){return null==this._reduce&&this.finder.calculate(this),this._reduce}},list:{get:function(){return null==this._list&&this.finder.calculate(this),this._list}},hash:{get:function(){return null==this._hash&&this.finder.calculate(this),this._hash}},memory:{get:function(){return null==this._memory&&this.finder.calculate(this),this._memory}},ids:{get:function(){return Object.keys(this.memory)}}}),a}()}.call(this),function(){var a,b,c,d,e,f,g,h,i=[].slice,j=function(a,b){function c(){this.constructor=a}for(var d in b)k.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},k={}.hasOwnProperty;b=require("lodash"),c=function(a,b,c){switch(null!=c?c.constructor:void 0){case Function:return b.query.all[a]=function(){var d,e,f;return d=1<=arguments.length?i.call(arguments,0):[],null!=(e=b.query)[f=a+":"+JSON.stringify(d)]?e[f]:e[f]=c.apply(null,d)};default:return b.query.all[a]=c}},g=function(a,b){var c,d,e;this.finder.diff={},d=this.finder.query.all._memory;for(c in d){e=d[c],this.finder.query.all._memory={};break}return this.set_base("merge",a,b)},e=function(a,b){return this.set_base("merge",a,b)},f=function(a){return this.set_base(!1,a,null)},d=function(a){return function(b,c){return a.call(this,[b],c)}},h=function(){return this.finder.rehash(this.responses)},a=module.exports,a.Rule=function(){function b(a){this.field=a,this.model_id=this.field+"_id",this.model_list=this.field+"s"}return b.responses={},b.Model=function(){function a(a,b){a._id||(a._id=a[b.id]),a[b.id]||(a[b.id]=a._id)}return a.update=function(a,b){},a.create=function(a){},a["delete"]=function(a){},a}(),b.prototype.set=g,b.prototype.reset=g,b.prototype.merge=e,b.prototype.reject=f,b.prototype.add=d(e),b.prototype.append=d(e),b.prototype.create=d(e),b.prototype.remove=d(f),b.prototype.clear_cache=h,b.prototype.refresh=h,b.prototype.rehash=h,b.prototype.schema=function(b){var d,e,f,g,h,k,l;for(this.responses=null!=(d=a.Rule.responses)[l=this.field]?d[l]:d[l]=[],this.finder=new a.Finder("_id"),g=[],this.validates=[],e={scope:function(a){return function(b){var d,e,f,g;a.finder.scope=b(a.finder.query.all),f=a.finder.scope,g=[];for(d in f)e=f[d],g.push(c(d,a.finder,e));return g}}(this),depend_on:function(b){return function(c){var d;return null==(d=a.Rule.responses)[c]&&(d[c]=[]),a.Rule.responses[c].push(b)}}(this),belongs_to:function(b){return function(c,d){var f,h,i;return i=c+"s",h=c+"_id",g.push(function(){return Object.defineProperty(b.model.prototype,c,{get:function(){return a.Query[i].find(this[h])}})}),f=null!=d?d.dependent:void 0,f?(e.depend_on(c),b.validates.push(function(a){return null!=a[c]})):void 0}}(this),has_many:function(b){return function(d,e){var f,h,i;return h=b.model_id,f=b.finder.query.all,i=null!=e?e.query:void 0,c(d,b.finder,function(b){return null==i&&(i=a.Query[d]),i.where(function(a){return a[h]===b})}),g.push(function(){return Object.defineProperty(b.model.prototype,d,{get:function(){return f[d](this._id)}})})}}(this),shuffle:function(){var b;return b=this.finder.query.all.shuffle(),b._memory=this.finder.query.all._memory,a.Query[this.model_list]=this.finder.query.all=b},order:function(b){return function(c,d){var e;return e=b.finder.query.all.sort(c,d),e._memory=b.finder.query.all._memory,a.Query[b.model_list]=b.finder.query.all=e}}(this),protect:function(a){return function(){var b;return b=1<=arguments.length?i.call(arguments,0):[],a.protect=function(a,c){var d,e,f,g;for(g=[],d=0,f=b.length;f>d;d++)e=b[d],g.push(a[e]=c[e]);return g}}}(this),model:a.Rule.Model},b.call(e,this),this.model=e.model,this.model.id=this.model_id,this.model.list=this.model_list,e.model===a.Rule.Model&&(this.model=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return j(b,a),b}(this.model)),h=0,k=g.length;k>h;h++)(f=g[h])();return a.Model[this.field]=this.model,a.Collection[this.field]=this,a.Query[this.model_list]=this.finder.query.all,this},b.prototype.set_base=function(a,b,c){var d,e,f;switch(f=this.finder,f.map_reduce=null!=this.model.map_reduce,d=f.query.all._memory,e=function(a){var c,d,e,f,g,h;switch(null!=b?b.constructor:void 0){case Array:for(g=b||[],c=0,f=g.length;f>c;c++)e=g[c],e&&a(e);break;case Object:h=b||{};for(d in h)e=h[d],e&&(e._id=d,a(e))}},a){case"merge":e(function(a){return function(b){var e,g,h,j,k,l,m,n,o,p;for(k in c)p=c[k],b[k]=p;for(b.__proto__=a.model.prototype,a.model.call(b,b,a.model),h=!0,o=a.validates,j=0,l=o.length;l>j;j++)if(e=o[j],!e(b)){h=!1;break}h&&(m={item:b,emits:[]},n=d[b._id],null!=n?a.model.update(b,n):a.model.create(b),d[b._id]=m,f.map_reduce&&(g=function(){var a,b,c;return c=2<=arguments.length?i.call(arguments,0,b=arguments.length-1):(b=0,[]),a=arguments[b++],m.emits.push([c,a])},a.model.map_reduce(b,g)))}}(this));break;default:e(function(a){return function(b){var c;c=d[b._id],null!=c&&(a.model["delete"](c),delete d[b._id])}}(this))}this.rehash()},b}()}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;j=null,d=function(a){var b,c,d,e,f;for(j={to_s:a,to_i:{}},f=j.to_s,e=c=0,d=f.length;d>c;e=++c)b=f[e],j.to_i[b]=e;return j.size=j.to_s.length},d("0123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),i=j.size*j.size*j.size,o=function(a){return function(b){switch(b){case"":case null:case void 0:return"";default:return a(b)}}},k=l=o(String),m=o(decodeURI),q=o(encodeURI),n=o(function(a){return String(a).replace(/[~\/=.&\?\#\[\]()\"'`;]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}),c=function(a){if(Array.isArray(a))return a;switch(a){case"":case null:case void 0:return[];default:return k(a).split(",")}},h={Url:{},Thru:function(a){return a},Keys:function(a){var b,c,d;return d=function(){var d;if(Array.isArray(a))return a;d=[];for(c in a)b=a[c],b&&d.push(c);return d}(),h.Array(d.sort())},Array:function(a){return Array.isArray(a)?a.join(","):k(a)},Date:function(a){var b,c;for(c=Math.floor(a),b="";c>=1;)b+=j.to_s[c%j.size],c=Math.floor(c/j.size);return b},Bool:function(a){return a?"T":"F"},Text:n,Cookie:n,Url:q,Number:l,String:l,"null":l,undefined:l},p={Url:{},Thru:function(a){return a},HtmlGon:function(a){var b,c,d;for(c=/<script.*?>([\s\S]*?)<\/script>/gi,b=[];d=c.exec(a);)b.push(d[1]);return new Function("window",b.join("\n"))},Keys:function(a){var b,d,e,f,g,h;if(d={},a.length)for(h=c(a),e=0,g=h.length;g>e;e++)f=h[e],d[f]=!0;else for(f in a)b=a[f],b&&(d[f]=!0);return d},Array:function(a){return c(a)},Date:function(a){var b,c,e,f,g;if(a>0)return a;for(d=1,g=0,c=0,e=a.length;e>c;c++){if(b=a[c],f=j.to_i[b],null==f)return Number.NaN;g+=f*d,d*=j.size}return g},Bool:function(a){switch(a){case!0:case"T":return!0;case!1:case"F":return!1;default:return Number.NaN}},Text:m,Cookie:m,Url:m,Number:Number,String:k,"null":k,undefined:k},b={url:{},ID:{now:function(){return b.ID.at(_.now())},at:function(a,b){return null==b&&(b=Math.random()*i),h.Date(a*i+b)}}},e="([^\\~\\/\\=\\.\\&\\[\\]\\(\\)\\\"\\'\\`\\;]*)";for(g in p)f=p[g],b.url[g]=function(){switch(g){case"Number":return"([-]?[\\.0-9]+)";case"Date":return"([0-9a-zA-Z]+)";case"Array":case"Keys":return e;case"Url":case"Cookie":return e;case"Text":return e;default:return e}}();a=module.exports,a.pack=h,a.unpack=p,a.Serial=b}.call(this);
//# sourceMappingURL=memory-record.min.js.map