/**
 memory-record - activerecord like in-memory data manager
 @version v0.2.0
 @link https://github.com/7korobi/memory-record
 @license 
**/


(function(){Object.defineProperties(Array.prototype,{first:{get:function(){return this[0]}},last:{get:function(){return this[this.length-1]}},cycle:{value:function(a){var b,c,d,e;for(e=[],c=b=0,d=a;d>=0?d>=b:b>=d;c=d>=0?++b:--b)e.push(this[c%this.length]);return e}}})}).call(this),function(){var a;module.exports=a={Base:{},Query:{},Model:{},Collection:{},Composite:{}}}.call(this),function(){var a,b,c,d,e,f,g,h=[].slice;b=function(){return new Object(null)},g=function(a,c){var d,e,f,g,h,i,j,k;j=this.rule,e=j.finder,h=j.model,d=e.query.all._memory,e.query.all._memory=b(),this.set_base("merge",a,c),k=[];for(g in d)i=d[g],f=e.query.all._memory[g],null!=f?k.push(h.update(f,i)):k.push(h["delete"](i));return k},e=function(a,b){return this.set_base("merge",a,b)},f=function(a){return this.set_base(!1,a,null)},d=function(a){return function(b,c){return a.call(this,[b],c)}},c=function(){return this.rule.composite()},a=module.exports,a.Base.Collection=function(){function a(a){this.rule=a,this.validates=[]}return a.prototype.set=g,a.prototype.reset=g,a.prototype.merge=e,a.prototype.reject=f,a.prototype.add=d(e),a.prototype.append=d(e),a.prototype.create=d(e),a.prototype.remove=d(f),a.prototype.clear_cache=c,a.prototype.refresh=c,a.prototype.rehash=c,a.prototype.set_base=function(a,b,c){var d,e,f,g,i;switch(i=this.rule,f=i.finder,g=i.model,d=f.query.all._memory,e=function(a){var c,d,e,f,g,h;switch(null!=b?b.constructor:void 0){case Array:for(g=b||[],c=0,f=g.length;f>c;c++)e=g[c],e&&a(e);break;case Object:h=b||{};for(d in h)e=h[d],e&&(e._id=d,a(e))}},a){case"merge":e(function(a){return function(b){var e,i,j,k,l,m,n,o,p,q;for(l in c)q=c[l],b[l]=q;for(b.__proto__=g.prototype,g.call(b,b,g),j=!0,p=a.validates,k=0,m=p.length;m>k;k++)if(e=p[k],!e(b)){j=!1;break}j&&(n={item:b,emits:[]},o=d[b._id],null!=o?g.update(b,o):g.create(b),d[b._id]=n,f.map_reduce&&(i=function(){var a,b,c;return c=2<=arguments.length?h.call(arguments,0,b=arguments.length-1):(b=0,[]),a=arguments[b++],n.emits.push([c,a])},g.map_reduce(b,i)))}}(this));break;default:e(function(a){return function(a){var b;b=d[a._id],null!=b&&(g["delete"](b),delete d[a._id])}}(this))}this.clear_cache()},a}()}.call(this),function(){var a,b,c,d=[].slice;c=require("lodash"),b=function(){return new Object(null)},a=module.exports,a.Base.Finder=function(){function e(c,d){var e;this.sortBy=c,this.orderBy=d,e=new a.Base.Query(this,[],this.sortBy,this.orderBy),e._memory=b(),this.scope={all:e},this.query={all:e},this.cache=new WeakMap}return e.prototype.use_cache=function(a,b){switch(null!=b?b.constructor:void 0){case Function:return this.query.all[a]=function(c){return function(){var e,f,g;return e=1<=arguments.length?d.call(arguments,0):[],null!=(f=c.query.all)[g=a+":"+JSON.stringify(e)]?f[g]:f[g]=b.apply(null,e)}}(this);default:return this.query.all[a]=b}},e.prototype.rehash=function(){delete this.query.all._reduce,delete this.query.all._list,delete this.query.all._hash,this.query={all:this.query.all}},e.prototype._reduce=function(a){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;i=function(a){var c;return c=b(),a.count&&(c.count=0),a.all&&(c.all=0),a.list&&(c.list=[]),a.set&&(c.set=b()),c},p=function(a,b,c){return c.list&&b.list.push(c.list),c.set&&(b.set[c.set]=!0),c.max<=b.max||(b.max_is=a,b.max=c.max),b.min<=c.min||(b.min_is=a,b.min=c.min),c.count&&(b.count+=c.count),c.all?b.all+=c.all:void 0},e=function(a){return a.all&&a.count?a.avg=a.all/a.count:void 0},d=b(),o=b(),q=a._memory;for(h in q)for(r=q[h],j=r.item,f=r.emits,g=0,k=f.length;k>g;g++)s=f[g],n=s[0],l=s[1],m=c.get(d,n),m||(m=o[n.join(".")]=i(l),c.set(d,n,m)),p(j,m,l);for(n in o)m=o[n],e(m);return a._reduce=d},e.prototype._sort=function(a){var b,d;return d=a.sortBy,b=a.orderBy,null!=d?a._list=null!=b?c.orderBy(a._list,d,b):c.sortBy(a._list,d):void 0},e.prototype._group=function(a){var b,c,d,e,f;return e=a._distinct,d=e.reduce,f=e.target,a._list=function(){var e,g;e=a._reduce[d],g=[];for(b in e)c=e[b],g.push(c[f]);return g}()},e.prototype._list=function(a,c){var d,e,f,g,h;return a._memory===c?e=function(b,c){return a._hash[b]=c.item}:(a._memory=b(),e=function(b,c){return a._memory[b]=c,a._hash[b]=c.item}),a._hash=b(),a._list=function(){var b,i,j,k;k=[];for(g in c){for(h=c[g],f=!0,j=a.filters,b=0,i=j.length;i>b;b++)if(d=j[b],!d(h.item)){f=!1;break}f&&k.push(e(g,h))}return k}()},e.prototype.calculate=function(a){this._list(a,this.query.all._memory),a._list.length&&null!=this.map_reduce&&(this._reduce(a),null!=a._distinct&&this._group(a)),this._sort(a)},e}()}.call(this),function(){var a;a=module.exports,a.Base.Model=function(){function a(a,b){a._id||(a._id=a[b.id]),a[b.id]||(a[b.id]=a._id)}return a.update=function(a,b){},a.create=function(a){},a["delete"]=function(a){},a}()}.call(this),function(){var a,b,c,d,e=[].slice;c=require("lodash"),b=function(){return new Object(null)},d=function(a){var c,d,e,f;for(f=b(),c=0,e=a.length;e>c;c++)d=a[c],f[d]=!0;return f},a=module.exports,a.Base.Query=function(){function a(a,b,c,d){this.finder=a,this.filters=b,this.sortBy=c,this.orderBy=d}return a.prototype._filters=function(b,d){var e,f,g,h;if(!b)return this;switch(e=this.filters.concat(),h=null!=b?b.constructor:void 0){case Object:for(g in b)b=b[g],f=c.property(g),e.push(d(f,b));break;case Function:case Array:case String:f=function(a){return a},e.push(d(f,b));break;default:throw console.log([h,b]),Error("unimplemented")}return new a(this.finder,e,this.orderBy)},a.prototype["in"]=function(a){return this._filters(a,function(a,b){var c,e;switch(e=null!=b?b.constructor:void 0){case Array:return c=d(b),function(b){var d,e,f,g;for(g=a(b),d=0,f=g.length;f>d;d++)if(e=g[d],c[e])return!0;return!1};case RegExp:return function(c){var d,e,f,g;for(f=a(c),d=0,e=f.length;e>d;d++)if(g=f[d],b.test(g))return!0;return!1};case null:case Boolean:case String:case Number:return function(e){return c=d(a(e)),c[b]};default:throw console.log([e,b]),Error("unimplemented")}})},a.prototype.where=function(a){return this._filters(a,function(a,b){var c,e;switch(e=null!=b?b.constructor:void 0){case Function:return b;case Array:return c=d(b),function(b){return c[a(b)]};case RegExp:return function(c){return b.test(a(c))};case null:case Boolean:case String:case Number:return function(c){return b===a(c)};default:throw console.log([e,b]),Error("unimplemented")}})},a.prototype.search=function(a){var b,c,d;return a?(c=function(){var c,d,e,f;for(e=a.split(/\s+/),f=[],c=0,d=e.length;d>c;c++)b=e[c],b=b.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),b.length&&f.push("("+b+")");return f}(),c.length?(d=new RegExp(c.join("|"),"ig"),this.where(function(a){return!a.search_words||d.test(a.search_words)})):this):this},a.prototype.distinct=function(b,c){var d;return d=new a(this.finder,this.filters,this.orderBy),d._distinct={reduce:b,target:c},d},a.prototype.sort=function(b,d){return c.isEqual([b,d],[this.sortBy,this.orderBy])?this:new a(this.finder,this.filters,b,d)},a.prototype.shuffle=function(){return new a(this.finder,this.filters,Math.random)},a.prototype.clear=function(){return delete this._reduce,delete this._list,delete this._hash,delete this._memory},a.prototype.save=function(){return this.finder.save(this)},a.prototype.find=function(a){return this.hash[a]},a.prototype.finds=function(a){var b,c,d,e,f;for(f=[],b=0,d=a.length;d>b;b++)c=a[b],(e=this.hash[c])&&f.push(e);return f},a.prototype.pluck=function(){var a;switch(a=1<=arguments.length?e.call(arguments,0):[],a.length){case 0:return this.list.map(function(){return null});case 1:return this.list.map(function(b){var d;return d=c.at(b,a)[0]});default:return this.list.map(function(b){return c.at(b,a)})}},Object.defineProperties(a.prototype,{reduce:{get:function(){return null==this._reduce&&this.finder.calculate(this),this._reduce}},list:{get:function(){return null==this._list&&this.finder.calculate(this),this._list}},hash:{get:function(){return null==this._hash&&this.finder.calculate(this),this._hash}},memory:{get:function(){return null==this._memory&&this.finder.calculate(this),this._memory}},ids:{get:function(){return Object.keys(this.memory)}}}),a}()}.call(this),function(){var a,b,c=[].slice,d=function(a,b){function c(){this.constructor=a}for(var d in b)e.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},e={}.hasOwnProperty;b=require("lodash"),a=module.exports,a.Rule=function(){function b(a){this.field=a,this.model_id=this.field+"_id",this.model_list=this.field+"s",this.depend_on(this.field)}return b.prototype.composite=function(){var b,c,d,e;for(e=a.Composite[this.field],c=0,d=e.length;d>c;c++)(b=e[c])()},b.prototype.depend_on=function(b){var c;return null==(c=a.Composite)[b]&&(c[b]=[]),a.Composite[b].push(function(){return a.Collection[b].rule.finder.rehash()})},b.prototype.scope=function(a){var b,c,d,e;this.finder.scope=a(this.finder.query.all),d=this.finder.scope,e=[];for(b in d)c=d[b],e.push(this.finder.use_cache(b,c));return e},b.prototype.belongs_to=function(b,c){var d,e,f;return f=b+"s",e=b+"_id",this.deploys.push(function(c){return function(){return Object.defineProperty(c.model.prototype,b,{get:function(){return a.Query[f].find(this[e])}})}}(this)),d=null!=c?c.dependent:void 0,d?(this.depend_on(b),this.dml.validates.push(function(a){return null!=a[b]})):void 0},b.prototype.has_many=function(b,c){var d,e,f;return e=this.model_id,d=this.finder.query.all,f=null!=c?c.query:void 0,this.finder.use_cache(b,function(c){return null==f&&(f=a.Query[b]),f.where(function(a){return a[e]===c})}),this.deploys.push(function(a){return function(){return Object.defineProperty(a.model.prototype,b,{get:function(){return d[b](this._id)}})}}(this))},b.prototype.shuffle=function(){var b;return b=this.finder.query.all.shuffle(),b._memory=this.finder.query.all._memory,a.Query[this.model_list]=this.finder.query.all=b},b.prototype.order=function(b,c){var d;return d=this.finder.query.all.sort(b,c),d._memory=this.finder.query.all._memory,a.Query[this.model_list]=this.finder.query.all=d},b.prototype.protect=function(){var a;return a=1<=arguments.length?c.call(arguments,0):[],this.protect=function(b,c){var d,e,f,g;for(g=[],d=0,f=a.length;f>d;d++)e=a[d],g.push(b[e]=c[e]);return g}},b.prototype.schema=function(b){var c,e,f,g;for(this.finder=new a.Base.Finder("_id"),this.model=a.Base.Model,this.dml=new a.Base.Collection(this),this.deploys=[],b.call(this,this.dml),this.model.id=this.model_id,this.model.list=this.model_list,this.model===a.Base.Model&&(this.model=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return d(b,a),b}(this.model)),this.dml.model=this.model,this.finder.map_reduce=null!=this.model.map_reduce,g=this.deploys,e=0,f=g.length;f>e;e++)(c=g[e])();return a.Model[this.field]=this.model,a.Collection[this.field]=this.dml,a.Query[this.model_list]=this.finder.query.all,this},b}()}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;b=function(){return new Object(null)},k=null,e=function(a){var b,c,d,e,f;for(k={to_s:a,to_i:{}},f=k.to_s,e=c=0,d=f.length;d>c;e=++c)b=f[e],k.to_i[b]=e;return k.size=k.to_s.length},e("0123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),j=k.size*k.size*k.size,p=function(a){return function(b){switch(b){case"":case null:case void 0:return"";default:return a(b)}}},l=m=p(String),n=p(decodeURI),r=p(encodeURI),o=p(function(a){return String(a).replace(/[~\/=.&\?\#\[\]()\"'`;]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}),d=function(a){if(Array.isArray(a))return a;switch(a){case"":case null:case void 0:return[];default:return l(a).split(",")}},i={Url:{},Thru:function(a){return a},Keys:function(a){var b,c,d;return d=function(){var d;if(Array.isArray(a))return a;d=[];for(c in a)b=a[c],b&&d.push(c);return d}(),i.Array(d.sort())},Array:function(a){return Array.isArray(a)?a.join(","):l(a)},Date:function(a){var b,c;for(c=Math.floor(a),b="";c>=1;)b+=k.to_s[c%k.size],c=Math.floor(c/k.size);return b},Bool:function(a){return a?"T":"F"},Text:o,Cookie:o,Url:r,Number:m,String:m,"null":m,undefined:m},q={Url:{},Thru:function(a){return a},HtmlGon:function(a){var b,c,d;for(c=/<script.*?>([\s\S]*?)<\/script>/gi,b=[];d=c.exec(a);)b.push(d[1]);return new Function("window",b.join("\n"))},Keys:function(a){var c,e,f,g,h,i;if(e=b(),a.length)for(i=d(a),f=0,h=i.length;h>f;f++)g=i[f],e[g]=!0;else for(g in a)c=a[g],c&&(e[g]=!0);return e},Array:function(a){return d(a)},Date:function(a){var b,c,d,f,g;if(a>0)return a;for(e=1,g=0,c=0,d=a.length;d>c;c++){if(b=a[c],f=k.to_i[b],null==f)return Number.NaN;g+=f*e,e*=k.size}return g},Bool:function(a){switch(a){case!0:case"T":return!0;case!1:case"F":return!1;default:return Number.NaN}},Text:n,Cookie:n,Url:n,Number:Number,String:l,"null":l,undefined:l},c={url:{},ID:{now:function(){return c.ID.at(_.now())},at:function(a,b){return null==b&&(b=Math.random()*j),i.Date(a*j+b)}}},f="([^\\~\\/\\=\\.\\&\\[\\]\\(\\)\\\"\\'\\`\\;]*)";for(h in q)g=q[h],c.url[h]=function(){switch(h){case"Number":return"([-]?[\\.0-9]+)";case"Date":return"([0-9a-zA-Z]+)";case"Array":case"Keys":return f;case"Url":case"Cookie":return f;case"Text":return f;default:return f}}();a=module.exports,a.pack=i,a.unpack=q,a.Serial=c}.call(this);
//# sourceMappingURL=memory-record.min.js.map