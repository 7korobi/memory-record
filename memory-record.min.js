/**
 memory-record - activerecord like in-memory data manager
 @version v0.1.5
 @link https://github.com/7korobi/memory-record
 @license 
**/


(function(){var a,b,c,d,e=[].slice;b=[].sort,a=function(a){var b;switch(null!=a?a.constructor:void 0){case Function:return a;case String:return b=a.split("."),function(a){var c,d,e;for(c=0,e=b.length;e>c;c++)d=b[c],a=a[d];return a};default:throw"not supported. scanner"}},d=function(a,b,c){var d,e,f,g;switch(null==c&&(c="asc"),c){case"asc":e=-1,d=1;break;case"desc":e=1,d=-1;break;default:throw"not supported. sort_method1 "+c}switch(g=function(a,b){return b>a?e:a>b?d:0},null!=b?b.constructor:void 0){case Object:throw"not supported. sort_method3 "+JSON.stringify(b);break;case Array:switch(null!=(f=b[0])?f.constructor:void 0){case Array:case Object:throw"not supported. sort_method2 "+b[0]}return function(b,c){var d,e,f,h,i,j,k,l;for(e=a[b],h=a[c],k=j=0,l=e.length;l>j;k=++j)if(d=e[k],f=h[k],i=g(d,f))return i;return 0};default:return function(b,c){var d,e;return d=a[b],e=a[c],g(d,e)}}},c=function(a,c,e){var f;return b.call(function(){f=[];for(var a=0,b=e.length;b>=0?b>a:a>b;b>=0?a++:a--)f.push(a);return f}.apply(this),d(c,c[0],a)).map(function(a){return e[a]})},Object.defineProperties(Array.prototype,{first:{get:function(){return this[0]}},last:{get:function(){return this[this.length-1]}},choice:{get:function(){var a;return a=Math.floor(Math.random()*this.length),this[a]}},shuffle:{value:function(){return this.sortBy(function(a){return Math.random()})}},sort:{value:function(a){switch(a){case"asc":case"desc":return c(a,this,this);default:return b.call(this,a)}}},sortBy:{value:function(){var b,d,f,g,h,i;return b=2<=arguments.length?e.call(arguments,0,f=arguments.length-1):(f=0,[]),d=arguments[f++],i=b[0],d=a(d),h=function(){var a,b,c;for(c=[],a=0,b=this.length;b>a;a++)g=this[a],c.push(d(g));return c}.call(this),c(i,h,this)}}})}).call(this),function(){var a;module.exports=a={Query:{},Collection:{}}}.call(this),function(){var a;a=module.exports,a.Finder=function(){function b(b){var c;this.sort_by=b,c=new a.Query(this,[],"asc",this.sort_by),c._memory={},this.scope={all:c},this.query={all:c}}return b.prototype.rehash=function(a,b){var c,d,e;for(delete this.query.all._reduce,delete this.query.all._list,delete this.query.all._hash,this.query={all:this.query.all},c=0,d=a.length;d>c;c++)e=a[c],e.rehash(b)},b.prototype.calculate_reduce=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;h=function(a){var b;return b={},a.count&&(b.count=0),a.all&&(b.all=0),a.push&&(b.push=[]),a.set&&(b.set={}),b},r=function(a,b,c){return c.push&&b.push.push(c.push),c.set&&(b.set[c.set]=!0),c.max<=b.max||(b.max_is=a,b.max=c.max),b.min<=c.min||(b.min_is=a,b.min=c.min),c.count&&(b.count+=c.count),c.all?b.all+=c.all:void 0},c=function(a){return a.all&&a.count?a.avg=a.all/a.count:void 0},b={},s=a._memory;for(g in s)for(t=s[g],i=t.item,d=t.emits,f=0,n=d.length;n>f;f++){for(u=d[f],l=u[0],m=u[1],p=u[2],q=b,j=0,o=l.length;o>j;j++)k=l[j],q=q[k]||(q[k]={});q=q[m]||(q[m]=h(p)),r(i,q,p)}for(e in b){d=b[e];for(k in d)p=d[k],c(p)}return a._reduce=b},b.prototype.calculate_sort=function(a){return a._list=a._list.sortBy(a.type,a.sort_by)},b.prototype.calculate_group=function(a){var b,c,d,e,f;return e=a._distinct,d=e.reduce,f=e.target,a._list=function(){var e,g;e=a._reduce[d],g=[];for(b in e)c=e[b],g.push(c[f]);return g}()},b.prototype.calculate_list=function(a,b){var c,d,e,f;return a._memory===b?c=function(b,c){return a._hash[b]=c.item}:(a._memory={},c=function(b,c){return a._memory[b]=c,a._hash[b]=c.item}),a._hash={},a._list=function(){var g,h,i,j;j=[];for(e in b){for(f=b[e],i=a.filters,g=0,h=i.length;h>g&&(d=i[g],d(f.item)||(f=null),f);g++);f&&j.push(c(e,f))}return j}()},b.prototype.calculate=function(a){this.calculate_list(a,this.query.all._memory),a._list.length&&null!=this.map_reduce&&(this.calculate_reduce(a),null!=a._distinct&&this.calculate_group(a)),this.calculate_sort(a)},b}()}.call(this),function(){var a=[].slice;Math.permutation=function(b){var c,d,e,f,g,h,i,j;return c=[],e=[],g=[],j=[],b.call({repeated_combination:function(){var b,d;return d=arguments[0],b=2<=arguments.length?a.call(arguments,1):[],c.push(d),this.product(b)},combination:function(){var b,d;return d=arguments[0],b=2<=arguments.length?a.call(arguments,1):[],c.push(d),this.product(b)},product:function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],e.push(b)},shuffle:function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],g.push(b)},zip:function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],j.push(b)}}),h=0,i=Math.max(j.map(function(a){return a.length})),f=[],(d=function(a,k){var l,m,n,o,p,q,r,s,t,u,v;if(null==k&&(k=[]),e[a]){for(q=e[a],m=0,o=q.length;o>m;m++){if(n=q[m],i&&h>i)return k;r=f[a-1]===n,r&&repeat_check||(f[a]=n,d(a+1,k)||(v=j.map(function(a){return a[h]}),t=g.map(function(a){return a.choice}),h++,l=0,p=0,s=0,u=0,k.push(b.call({repeated_combination:function(){var b,d,e,f;for(d=c[l++],f=[],a=b=0,e=d;e>=0?e>=b:b>=e;a=e>=0?++b:--b)f.push(this.product());return f},combination:function(){var b,d,e,f;for(d=c[l++],f=[],a=b=0,e=d;e>=0?e>=b:b>=e;a=e>=0?++b:--b)f.push(this.product());return f},product:function(){return f[p++]},shuffle:function(){return t[s++]},zip:function(){return v[u++]}}))))}return k}})(0)}}.call(this),function(){var a,b,c=[].slice;b=function(a){var b,c,d,e;for(e={},b=0,d=a.length;d>b;b++)c=a[b],e[c]=!0;return e},a=module.exports,a.Query=function(){function a(a,b,c,d){this.finder=a,this.filters=b,this.type=c,this.sort_by=d}return a.prototype._filters=function(b,c){var d,e,f;if(!b)return this;switch(d=this.filters.concat(),null!=b?b.constructor:void 0){case Object:for(f in b)e=b[f],d.push(c(f,e));break;case Function:d.push(c(null,b));break;default:throw console.log([type(b,b)]),Error("unimplemented")}return new a(this.finder,d,this.type,this.sort_by)},a.prototype["in"]=function(a){return this._filters(a,function(a,c){switch(null!=c?c.constructor:void 0){case Array:return function(d){var e,f,g,h;for(h=b(d[a]),e=0,g=c.length;g>e;e++)if(f=c[e],h[f])return!0;return!1};case RegExp:return function(b){var d,e,f,g;for(f=b[a],d=0,e=f.length;e>d;d++)if(g=f[d],c.test(g))return!0;return!1};case null:case Boolean:case String:case Number:return function(d){var e;return e=b(d[a]),e[c]};default:throw console.log([null!=c?c.constructor:void 0,c]),Error("unimplemented")}})},a.prototype.distinct=function(b,c){var d;return d=new a(this.finder,this.filters,this.type,this.sort_by),d._distinct={reduce:b,target:c},d},a.prototype.where=function(a){return this._filters(a,function(a,c){var d;switch(null!=c?c.constructor:void 0){case Array:return d=b(c),function(b){return d[b[a]]};case RegExp:return function(b){return c.test(b[a])};case Function:return c;case null:case Boolean:case String:case Number:return function(b){return b[a]===c};default:throw console.log([type(c,c)]),Error("unimplemented")}})},a.prototype.search=function(a){var b,c,d;return a?(c=function(){var c,d,e,f;for(e=a.split(/\s+/),f=[],c=0,d=e.length;d>c;c++)b=e[c],b=b.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),b.length&&f.push("("+b+")");return f}(),c.length?(d=new RegExp(c.join("|"),"ig"),this.where(function(a){return!a.search_words||d.test(a.search_words)})):this):this},a.prototype.sort=function(b,c){return null==c&&(c=this.sort_by),b===this.type&&c===this.sort_by?this:new a(this.finder,this.filters,b,c)},a.prototype.shuffle=function(){return new a(this.finder,this.filters,"asc",Math.random)},a.prototype.clear=function(){return delete this._reduce,delete this._list,delete this._hash,delete this._memory},a.prototype.save=function(){return this.finder.save(this)},a.prototype.find=function(a){return this.hash[a]},a.prototype.finds=function(a){var b,c,d,e,f;for(f=[],b=0,d=a.length;d>b;b++)c=a[b],(e=this.hash[c])&&f.push(e);return f},a.prototype.pluck=function(){var a,b;switch(b=1<=arguments.length?c.call(arguments,0):[],b.length){case 0:return this.list.map(function(){return null});case 1:return a=b[0],this.list.map(function(b){return b[a]});default:return this.list.map(function(c){var d,e,f;for(f=[],d=0,e=b.length;e>d;d++)a=b[d],f.push(c[a]);return f})}},Object.defineProperties(a.prototype,{reduce:{get:function(){return null==this._reduce&&this.finder.calculate(this),this._reduce}},list:{get:function(){return null==this._list&&this.finder.calculate(this),this._list}},hash:{get:function(){return null==this._hash&&this.finder.calculate(this),this._hash}},memory:{get:function(){return null==this._memory&&this.finder.calculate(this),this._memory}},ids:{get:function(){return Object.keys(this.memory)}}}),a}()}.call(this),function(){var a,b,c,d=[].slice;c=function(a){return null!=a?a.constructor:void 0},b=function(a,b,c){var d,e,f,g;f=c.get,g=c.set,d=!1,e=!1,Object.defineProperty(a,b,{configurable:d,enumerable:e,get:f,set:g})},a=module.exports,a.Rule=function(){function e(b){var c;this.id=b+"_id",this.list_name=b+"s",this.base_obj={},this.validates=[],this.responses=null!=(c=a.Rule.responses)[b]?c[b]:c[b]=[],this.map_reduce=function(){},this.protect=function(){},this.deploy=function(a){return function(b){return b._id||(b._id=b[a.id]),b[a.id]?void 0:b[a.id]=b._id}}(this),this.finder=new a.Finder(function(a){return a._id}),this.finder.name=this.list_name,a.Collection[b]=this,a.Query[this.list_name]=this.finder.query.all}var f,g,h,i;return e.responses={},i=function(a,b){var c,d,e;this.finder.diff={},d=this.finder.query.all._memory;for(c in d){e=d[c],this.finder.query.all._memory={},this.finder.diff.del=!0;break}return this.set_base("merge",a,b)},g=function(a,b){return this.finder.diff={},this.set_base("merge",a,b)},h=function(a){return this.finder.diff={},this.set_base(!1,a,null)},f=function(a){return function(b,d){switch(c(b)){case Object:return a.call(this,[b],d);default:throw Error("invalid data : #{item}")}}},e.prototype.set=i,e.prototype.reset=i,e.prototype.merge=g,e.prototype.reject=h,e.prototype.add=f(g),e.prototype.create=f(g),e.prototype.remove=f(h),e.prototype.schema=function(e){var f,g;return f=function(a,b,e){switch(c(e)){case Function:return b.query.all[a]=function(){var c,f,g;return c=1<=arguments.length?d.call(arguments,0):[],null!=(f=b.query)[g=a+":"+JSON.stringify(c)]?f[g]:f[g]=e.apply(null,c)};default:return b.query.all[a]=e}},g={sync:function(a){return function(b,c){return null==c&&(c=a.list_name),a.finder.sync=new b(c)}}(this),scope:function(a){return function(b){var c,d,e,g;a.finder.scope=b(a.finder.query.all),e=a.finder.scope,g=[];for(c in e)d=e[c],g.push(f(c,a.finder,d));return g}}(this),"default":function(a){return function(b){var c,d,e,f;d=b(),e=[];for(c in d)f=d[c],e.push(a.base_obj[c]=f);return e}}(this),depend_on:function(b){return function(c){var d;return null==(d=a.Rule.responses)[c]&&(d[c]=[]),a.Rule.responses[c].push(b)}}(this),belongs_to:function(c){return function(d,e){var f,h,i;return i=d+"s",h=d+"_id",b(c.base_obj,d,{get:function(){return a.Query[i].find(this[h])}}),f=null!=(null!=e?e.dependent:void 0),f?(g.depend_on(d),c.validates.push(function(a){return null!=a[d]})):void 0}}(this),has_many:function(c){return function(d,e){var g,h,i;return h=c.id,g=c.finder.query.all,i=null!=e?e.query:void 0,f(d,c.finder,function(b){return null==i&&(i=a.Query[d]),i.where(function(a){return a[h]===b})}),b(c.base_obj,d,{get:function(){return g[d](this._id)}})}}(this),shuffle:function(){var b;return b=this.finder.query.all.shuffle(),b._memory=this.finder.query.all._memory,a.Query[this.list_name]=this.finder.query.all=b},order:function(b){return function(c){var d;return d=b.finder.query.all.sort(!1,c),d._memory=b.finder.query.all._memory,a.Query[b.list_name]=b.finder.query.all=d}}(this),protect:function(a){return function(){var b;return b=1<=arguments.length?d.call(arguments,0):[],a.protect=function(a,c){var d,e,f,g;for(g=[],d=0,f=b.length;f>d;d++)e=b[d],g.push(a[e]=c[e]);return g}}}(this),deploy:function(a){return function(b){a.deploy=b}}(this),map_reduce:function(a){return function(b){a.map_reduce=b}}(this)},e.call(g,this)},e.prototype.rehash=function(a){return this.finder.rehash(this.responses,a)},e.prototype.set_base=function(a,b,e){var f,g,h,i,j,k;switch(j=this.finder,h=j.diff,f=j.query.all._memory,g=function(a){return function(b){return b.__proto__=a.base_obj,a.deploy(b)}}(this),k=function(a){return function(b){var c,d,e,f;for(e=a.validates,c=0,d=e.length;d>c;c++)if(f=e[c],!f(b))return!1;return!0}}(this),i=function(a){var d,e,f,g,h,i;switch(c(b)){case Array:for(h=b||[],d=0,g=h.length;g>d;d++)f=h[d],f&&a(f);break;case Object:i=b||{};for(e in i)f=i[e],f&&(f._id=e,a(f))}},a){case"merge":i(function(a){return function(b){var c,i,l,m,n;for(i in e)n=e[i],b[i]=n;g(b),k(b)&&(l={item:b,emits:[]},m=f[b._id],null!=m?(a.protect(b,m.item),h.change=!0):h.add=!0,f[b._id]=l,c=function(){var a,b,c,e;return b=3<=arguments.length?d.call(arguments,0,a=arguments.length-2):(a=0,[]),c=arguments[a++],e=arguments[a++],j.map_reduce=!0,l.emits.push([b,c,e])},a.map_reduce(l.item,c))}}(this));break;default:i(function(a){return function(a){var b;b=f[a._id],null!=b&&(h.del=!0,delete f[a._id])}}(this))}this.rehash(h)},e}()}.call(this),function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;j=null,d=function(a){var b,c,d,e,f;for(j={to_s:a,to_i:{}},f=j.to_s,e=c=0,d=f.length;d>c;e=++c)b=f[e],j.to_i[b]=e;return j.size=j.to_s.length},d("0123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"),i=j.size*j.size*j.size,o=function(a){return function(b){switch(b){case"":case null:case void 0:return"";default:return a(b)}}},k=l=o(String),m=o(decodeURI),q=o(encodeURI),n=o(function(a){return String(a).replace(/[~\/=.&\?\#\[\]()\"'`;]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})}),c=function(a){if(Array.isArray(a))return a;switch(a){case"":case null:case void 0:return[];default:return k(a).split(",")}},h={Url:{},Thru:function(a){return a},Keys:function(a){var b,c,d;return d=function(){var d;if(Array.isArray(a))return a;d=[];for(c in a)b=a[c],b&&d.push(c);return d}(),h.Array(d.sort())},Array:function(a){return Array.isArray(a)?a.join(","):k(a)},Date:function(a){var b,c;for(c=Math.floor(a),b="";c>=1;)b+=j.to_s[c%j.size],c=Math.floor(c/j.size);return b},Bool:function(a){return a?"T":"F"},Text:n,Cookie:n,Url:q,Number:l,String:l,"null":l,undefined:l},p={Url:{},Thru:function(a){return a},HtmlGon:function(a){var b,c,d;for(c=/<script.*?>([\s\S]*?)<\/script>/gi,b=[];d=c.exec(a);)b.push(d[1]);return new Function("window",b.join("\n"))},Keys:function(a){var b,d,e,f,g,h;if(d={},a.length)for(h=c(a),e=0,g=h.length;g>e;e++)f=h[e],d[f]=!0;else for(f in a)b=a[f],b&&(d[f]=!0);return d},Array:function(a){return c(a)},Date:function(a){var b,c,e,f,g;if(a>0)return a;for(d=1,g=0,c=0,e=a.length;e>c;c++){if(b=a[c],f=j.to_i[b],null==f)return Number.NaN;g+=f*d,d*=j.size}return g},Bool:function(a){switch(a){case!0:case"T":return!0;case!1:case"F":return!1;default:return Number.NaN}},Text:m,Cookie:m,Url:m,Number:Number,String:k,"null":k,undefined:k},b={url:{},ID:{now:function(){return b.ID.at(_.now())},at:function(a,b){return null==b&&(b=Math.random()*i),h.Date(a*i+b)}}},e="([^\\~\\/\\=\\.\\&\\[\\]\\(\\)\\\"\\'\\`\\;]*)";for(g in p)f=p[g],b.url[g]=function(){switch(g){case"Number":return"([-]?[\\.0-9]+)";case"Date":return"([0-9a-zA-Z]+)";case"Array":case"Keys":return e;case"Url":case"Cookie":return e;case"Text":return e;default:return e}}();a=module.exports,a.pack=h,a.unpack=p,a.Serial=b}.call(this);
//# sourceMappingURL=memory-record.min.js.map