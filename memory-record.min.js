/**
 memory-record - activerecord like in-memory data manager
 @version v0.0.10
 @link https://github.com/7korobi/memory-record
 @license 
**/
(function(){var t;module.exports=t={rule:{}}}).call(this),function(){var t;t=module.exports,t.Finder=function(){function e(e){var r;this.sort_by=e,r=new t.Query(this,[],!1,this.sort_by),r._memory={},this.scope={all:r},this.query={all:r}}return e.prototype.rehash=function(t,e){var r,n,i;for(delete this.query.all._reduce,delete this.query.all._list,delete this.query.all._hash,this.query={all:this.query.all},r=0,n=t.length;n>r;r++)i=t[r],i.rehash(e)},e.prototype.calculate_reduce=function(t){var e,r,n,i,u,s,o,l,c,a,h,f,d,p,_,m,y,g,v,b;o=function(t){var e;return e={},t.count&&(e.count=0),t.all&&(e.all=0),e},y=function(t,e,r){return r.max<=e.max||(e.max_is=t,e.max=r.max),e.min<=r.min||(e.min_is=t,e.min=r.min),r.count&&(e.count+=r.count),r.all?e.all+=r.all:void 0},r=function(t){return t.all&&t.count?t.avg=t.all/t.count:void 0},e={},g=t._memory;for(s in g)for(v=g[s],l=v.item,n=v.emits,u=0,d=n.length;d>u;u++){for(b=n[u],h=b[0],f=b[1],_=b[2],m=e,c=0,p=h.length;p>c;c++)a=h[c],m=m[a]||(m[a]={});m=m[f]||(m[f]=o(_)),y(l,m,_)}for(i in e){n=e[i];for(a in n)_=n[a],r(_)}return t._reduce=e},e.prototype.calculate_sort=function(t){var e,r,n,i,u,s,o,l,c;for(u=t._list,l=t.desc?[1,-1]:[-1,1],s=l[0],e=l[1],c=t.orders={},r=0,i=u.length;i>r;r++)o=u[r],c[o._id]=t.sort_by(o);return u.length&&(n=Array.isArray(t.sort_by(u[0]))),t._list=n?u.sort(function(t,r){var n,i,u,o,l,a,h;for(n=c[t._id],u=c[r._id],l=a=0,h=n.length;h>a;l=++a){if(i=n[l],o=u[l],o>i)return s;if(i>o)return e}return 0}):u.sort(function(t,r){var n,i;return n=c[t._id],i=c[r._id],i>n?s:n>i?e:0})},e.prototype.calculate_group=function(t){var e,r,n,i,u;return i=t._distinct,n=i.reduce,u=i.target,t._list=function(){var i,s;i=t._reduce[n],s=[];for(e in i)r=i[e],s.push(r[u]);return s}()},e.prototype.calculate_list=function(t,e){var r,n,i,u;return t._memory===e?r=function(e,r){return t._hash[e]=r.item}:(t._memory={},r=function(e,r){return t._memory[e]=r,t._hash[e]=r.item}),t._hash={},t._list=function(){var s,o,l,c;c=[];for(i in e){for(u=e[i],l=t.filters,s=0,o=l.length;o>s&&(n=l[s],n(u.item)||(u=null),u);s++);u&&c.push(r(i,u))}return c}()},e.prototype.calculate=function(t){this.calculate_list(t,this.query.all._memory),t._list.length&&null!=this.map_reduce&&(this.calculate_reduce(t),null!=t._distinct&&this.calculate_group(t)),this.calculate_sort(t)},e}()}.call(this),function(){var t,e,r,n,i=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1},u=[].slice;n=Object.prototype.toString,r=function(t){return n.call(t).slice(8,-1)},e=function(t,e,r){var n,i,u,s;u=r.get,s=r.set,n=!1,i=!1,Object.defineProperty(t,e,{configurable:n,enumerable:i,get:u,set:s})},t=module.exports,t.Query=function(){function n(t,e,r,n){this.finder=t,this.filters=e,this.desc=r,this.sort_by=n}return n.prototype._filters=function(e,n){var i,u,s;if(!e)return this;switch(i=this.filters.concat(),r(e)){case"Object":for(s in e)u=e[s],i.push(n(s,u));break;case"Function":i.push(n(null,e));break;default:throw console.log([r(e,e)]),Error("unimplemented")}return new t.Query(this.finder,i,this.desc,this.sort_by)},n.prototype["in"]=function(t){return this._filters(t,function(t,e){switch(r(e)){case"Array":return function(r){var n,u,s;for(n=0,s=e.length;s>n;n++)if(u=e[n],i.call(r[t],u)>=0)return!0;return!1};case"RegExp":return function(r){var n,i,u,s;for(u=r[t],n=0,i=u.length;i>n;n++)if(s=u[n],e.test(s))return!0;return!1};case"Null":case"Boolean":case"String":case"Number":return function(r){return i.call(r[t],e)>=0};default:throw console.log([r(e,e)]),Error("unimplemented")}})},n.prototype.distinct=function(e,r){var n;return n=new t.Query(this.finder,this.filters,this.desc,this.sort_by),n._distinct={reduce:e,target:r},n},n.prototype.where=function(t){return this._filters(t,function(t,e){switch(r(e)){case"Array":return function(r){var n;return n=r[t],i.call(e,n)>=0};case"RegExp":return function(r){return e.test(r[t])};case"Function":return e;case"Null":case"Boolean":case"String":case"Number":return function(r){return r[t]===e};default:throw console.log([r(e,e)]),Error("unimplemented")}})},n.prototype.search=function(t){var e,r,n;return t?(r=function(){var r,n,i,u;for(i=t.split(/\s+/),u=[],r=0,n=i.length;n>r;r++)e=i[r],e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),e.length&&u.push("("+e+")");return u}(),r.length?(n=new RegExp(r.join("|"),"ig"),this.where(function(t){return!t.search_words||n.test(t.search_words)})):this):this},n.prototype.sort=function(e,n){var i;return null==n&&(n=this.sort_by),i=function(){switch(r(n)){case"Function":return n;case"String":case"Number":return function(t){return t[n]};default:throw console.log([r(req,req)]),Error("unimplemented")}}(),e===this.desc&&i===this.sort_by?this:new t.Query(this.finder,this.filters,e,i)},n.prototype.clear=function(){return delete this._reduce,delete this._list,delete this._hash,delete this._memory},e(n.prototype,"reduce",{get:function(){return null==this._reduce&&this.finder.calculate(this),this._reduce}}),e(n.prototype,"list",{get:function(){return null==this._list&&this.finder.calculate(this),this._list}}),e(n.prototype,"hash",{get:function(){return null==this._hash&&this.finder.calculate(this),this._hash}}),e(n.prototype,"memory",{get:function(){return null==this._memory&&this.finder.calculate(this),this._memory}}),e(n.prototype,"ids",{get:function(){return Object.keys(this.memory)}}),n.prototype.find=function(t){return this.hash[t]},n.prototype.finds=function(t){var e,r,n,i,u;for(u=[],e=0,n=t.length;n>e;e++)r=t[e],(i=this.hash[r])&&u.push(i);return u},n.prototype.pluck=function(){var t;switch(t=1<=arguments.length?u.call(arguments,0):[],t.length){case 0:return this.list.map(function(){return null});case 1:return this.list.map(function(e){return e[t[0]]});default:return this.list.map(function(e){var r,n,i,u;for(u=[],r=0,i=t.length;i>r;r++)n=t[r],u.push(e[n]);return u})}},n}()}.call(this),function(){var t,e,r,n,i=[].slice;n=Object.prototype.toString,r=function(t){return n.call(t).slice(8,-1)},e=function(t,e,r){var n,i,u,s;u=r.get,s=r.set,n=!1,i=!1,Object.defineProperty(t,e,{configurable:n,enumerable:i,get:u,set:s})},t=module.exports,t.Rule=function(){function n(e){var r;this.id=e+"_id",this.list_name=e+"s",this.base_obj={},this.validates=[],this.responses=null!=(r=t.Rule.responses)[e]?r[e]:r[e]=[],this.map_reduce=function(){},this.protect=function(){},this.deploy=function(t){return function(e){return e._id||(e._id=e[t.id]),e[t.id]?void 0:e[t.id]=e._id}}(this),this.finder=new t.Finder(function(t){return t}),this.finder.name=this.list_name,t.rule[e]=this,t[this.list_name]=this.finder.query.all}return n.responses={},n.prototype.schema=function(n){var u,s;return u=function(t,e,n){switch(r(n)){case"Function":return e.query.all[t]=function(){var r,u,s;return r=1<=arguments.length?i.call(arguments,0):[],null!=(u=e.query)[s=t+":"+JSON.stringify(r)]?u[s]:u[s]=n.apply(null,r)};default:return e.query.all[t]=n}},s={scope:function(t){return function(e){var r,n,i,s;t.finder.scope=e(t.finder.query.all),i=t.finder.scope,s=[];for(r in i)n=i[r],s.push(u(r,t.finder,n));return s}}(this),"default":function(t){return function(e){var r,n,i,u;n=e(),i=[];for(r in n)u=n[r],i.push(t.base_obj[r]=u);return i}}(this),depend_on:function(e){return function(r){var n;return null==(n=t.Rule.responses)[r]&&(n[r]=[]),t.Rule.responses[r].push(e)}}(this),belongs_to:function(r){return function(n,i){var u,o,l;return l=n+"s",o=n+"_id",e(r.base_obj,n,{get:function(){return t[l].find(this[o])}}),u=null!=(null!=i?i.dependent:void 0),u?(s.depend_on(n),r.validates.push(function(t){return null!=t[n]})):void 0}}(this),has_many:function(r){return function(n,i){var s,o,l;return o=r.id,s=r.finder.query.all,l=null!=i?i.query:void 0,u(n,r.finder,function(e){return null==l&&(l=t[n]),l.where(function(t){return t[o]===e})}),e(r.base_obj,n,{get:function(){return s[n](this._id)}})}}(this),order:function(e){return function(r){var n;return n=e.finder.query.all.sort(!1,r),n._memory=e.finder.query.all._memory,t[e.list_name]=e.finder.query.all=n}}(this),protect:function(t){return function(){var e;return e=1<=arguments.length?i.call(arguments,0):[],t.protect=function(t,r){var n,i,u,s;for(s=[],n=0,u=e.length;u>n;n++)i=e[n],s.push(t[i]=r[i]);return s}}}(this),deploy:function(t){return function(e){t.deploy=e}}(this),map_reduce:function(t){return function(e){t.map_reduce=e}}(this)},n.call(s,this)},n.prototype.rehash=function(t){return this.finder.rehash(this.responses,t)},n.prototype.set_base=function(t,e,n){var u,s,o,l,c,a;switch(c=this.finder,o=c.diff,u=c.query.all._memory,s=function(t){return function(e){return e.__proto__=t.base_obj,t.deploy(e)}}(this),a=function(t){return function(e){var r,n,i,u;for(i=t.validates,r=0,n=i.length;n>r;r++)if(u=i[r],!u(e))return!1;return!0}}(this),l=function(t){var n,i,u,s,o,l;switch(r(e)){case"Array":for(o=e||[],n=0,s=o.length;s>n;n++)u=o[n],u&&t(u);break;case"Object":l=e||{};for(i in l)u=l[i],u&&(u._id=i,t(u))}},t){case"merge":l(function(t){return function(e){var r,l,h,f,d;for(l in n)d=n[l],e[l]=d;s(e),a(e)&&(h={item:e,emits:[]},f=u[e._id],null!=f?(t.protect(e,f.item),o.change=!0):o.add=!0,u[e._id]=h,r=function(){var t,e,r,n;return e=3<=arguments.length?i.call(arguments,0,t=arguments.length-2):(t=0,[]),r=arguments[t++],n=arguments[t++],c.map_reduce=!0,h.emits.push([e,r,n])},t.map_reduce(h.item,r))}}(this));break;default:l(function(t){return function(t){var e;e=u[t._id],null!=e&&(o.del=!0,delete u[t._id])}}(this))}this.rehash(o)},n.prototype.set=function(t,e){var r,n,i;this.finder.diff={},n=this.finder.query.all._memory;for(r in n){i=n[r],this.finder.query.all._memory={},this.finder.diff.del=!0;break}return this.set_base("merge",t,e)},n.prototype.reject=function(t){return this.finder.diff={},this.set_base(!1,t,null)},n.prototype.merge=function(t,e){return this.finder.diff={},this.set_base("merge",t,e)},n}()}.call(this);